name: Discord Notifications

on:
  pull_request_target:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    # ë¦¬ë·° ì•Œë¦¼ì€ ë‚´ë¶€ PRë§Œ í—ˆìš©(í¬í¬ PR ì‹œí¬ë¦¿ ë¯¸ì „ë‹¬ ë°©ì§€)
    if: ${{ github.event_name != 'pull_request_review' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: PR Opened
        if: ${{ github.event_name == 'pull_request_target' && github.event.action == 'opened' }}
        run: |
          cat > payload.json <<JSON
          {
            "embeds": [{
              "title": "ðŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!",
              "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
              "color": 3447003,
              "fields": [
                { "name": "ðŸ‘¤ ìž‘ì„±ìž", "value": "${{ github.event.pull_request.user.login }}", "inline": true },
                { "name": "ðŸŒ¿ ë¸Œëžœì¹˜", "value": "`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`", "inline": true },
                { "name": "ðŸ“Š ë³€ê²½ì‚¬í•­", "value": "+${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}", "inline": true }
              ],
              "timestamp": "${{ github.event.pull_request.created_at }}"
            }]
          }
          JSON
          curl -sS -H "Content-Type: application/json" -X POST --data @payload.json "$DISCORD_WEBHOOK_URL"

      - name: Mention Reviewers
        if: ${{ github.event_name == 'pull_request_target' && github.event.action == 'review_requested' }}
        run: |
          set -eo pipefail
          REVIEWERS_JSON='${{ toJSON(github.event.pull_request.requested_reviewers) }}'
          FIRST_REVIEWER=$(echo "$REVIEWERS_JSON" | jq -r '.[0].login // empty')
          CURRENT_REVIEWER="${{ github.event.requested_reviewer.login }}"

          if [ "$CURRENT_REVIEWER" = "$FIRST_REVIEWER" ] || [ -z "$FIRST_REVIEWER" ]; then
            MENTIONS=""
            for login in $(echo "$REVIEWERS_JSON" | jq -r '.[] | .login'); do
              case "$login" in
                "chen4023") MENTIONS="$MENTIONS <@683563560063991848>" ;;
                "devjaesung") MENTIONS="$MENTIONS <@1344112571330072626>" ;;
                "thepott") MENTIONS="$MENTIONS <@599242098683936770>" ;;
                "nari-0v0") MENTIONS="$MENTIONS <@323412514224209921>" ;;
                "jongwon-mac") MENTIONS="$MENTIONS <@580094234711818250>" ;;
                "Hyejeong00") MENTIONS="$MENTIONS <@848157222625607741>" ;;
                "bottle-gwon") MENTIONS="$MENTIONS <@361825785654542336>" ;;
                *) MENTIONS="$MENTIONS @$login" ;;
              esac
            done

            if [ -z "$MENTIONS" ]; then
              case "$CURRENT_REVIEWER" in
                "chen4023") MENTIONS="<@683563560063991848>" ;;
                "devjaesung") MENTIONS="<@1344112571330072626>" ;;
                "thepott") MENTIONS="<@599242098683936770>" ;;
                "nari-0v0") MENTIONS="<@323412514224209921>" ;;
                "jongwon-mac") MENTIONS="<@580094234711818250>" ;;
                "Hyejeong00") MENTIONS="<@848157222625607741>" ;;
                "bottle-gwon") MENTIONS="<@361825785654542336>" ;;
                *) MENTIONS="@$CURRENT_REVIEWER" ;;
              esac
            fi

            cat > payload.json <<JSON
            {
              "content": "ðŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** $MENTIONS",
              "embeds": [{
                "title": "ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ðŸ‘€",
                "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
                "color": 16776960,
                "fields": [
                  { "name": "ðŸ‘¤ PR ìž‘ì„±ìž", "value": "${{ github.event.pull_request.user.login }}", "inline": true },
                  { "name": "ðŸ“ ë³€ê²½ì‚¬í•­", "value": "íŒŒì¼ ${{ github.event.pull_request.changed_files }}ê°œ | +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}", "inline": false }
                ]
              }]
            }
            JSON
            curl -sS -H "Content-Type: application/json" -X POST --data @payload.json "$DISCORD_WEBHOOK_URL"
          else
            echo "skip"
          fi

      - name: Notify on PR Closed
        if: ${{ github.event_name == 'pull_request_target' && github.event.action == 'closed' }}
        run: |
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            STATUS="âœ… ë³‘í•© ì™„ë£Œ!"
            COLOR="65280"
            EMOJI="ðŸŽ‰"
          else
            STATUS="âŒ PR ë‹«íž˜"
            COLOR="16711680"
            EMOJI="ðŸš«"
          fi

          cat > payload.json <<JSON
          {
            "embeds": [{
              "title": "$EMOJI $STATUS",
              "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
              "color": $COLOR,
              "fields": [
                { "name": "ðŸ‘¤ ìž‘ì„±ìž", "value": "${{ github.event.pull_request.user.login }}", "inline": true },
                { "name": "ðŸŒ¿ ë¸Œëžœì¹˜", "value": "`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`", "inline": true }
              ]
            }]
          }
          JSON
          curl -sS -H "Content-Type: application/json" -X POST --data @payload.json "$DISCORD_WEBHOOK_URL"

      - name: Notify on Review Approved
        if: ${{ github.event_name == 'pull_request_review' && github.event.review.state == 'approved' }}
        run: |
          case "${{ github.event.pull_request.user.login }}" in
            "chen4023") AUTHOR_MENTION="<@683563560063991848>" ;;
            "devjaesung") AUTHOR_MENTION="<@1344112571330072626>" ;;
            "thepott") AUTHOR_MENTION="<@599242098683936770>" ;;
            "nari-0v0") AUTHOR_MENTION="<@323412514224209921>" ;;
            "jongwon-mac") AUTHOR_MENTION="<@580094234711818250>" ;;
            "Hyejeong00") AUTHOR_MENTION="<@848157222625607741>" ;;
            "bottle-gwon") AUTHOR_MENTION="<@361825785654542336>" ;;
            *) AUTHOR_MENTION="@${{ github.event.pull_request.user.login }}" ;;
          esac

          cat > payload.json <<JSON
          {
            "content": "ðŸ‘ **ë¦¬ë·°ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!** $AUTHOR_MENTION",
            "embeds": [{
              "title": "âœ… ë¦¬ë·° ìŠ¹ì¸ ì™„ë£Œ!",
              "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
              "color": 65280,
              "fields": [
                { "name": "ðŸ‘€ ë¦¬ë·°ì–´", "value": "${{ github.event.review.user.login }}", "inline": true },
                { "name": "ðŸ’¬ ë¦¬ë·° ë‚´ìš©", "value": "ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!", "inline": false }
              ],
              "footer": { "text": "ì´ì œ ë³‘í•©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤! ðŸš€" }
            }]
          }
          JSON
          curl -sS -H "Content-Type: application/json" -X POST --data @payload.json "$DISCORD_WEBHOOK_URL"

      - name: Notify on Changes Requested
        if: ${{ github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested' }}
        run: |
          case "${{ github.event.pull_request.user.login }}" in
            "chen4023") AUTHOR_MENTION="<@683563560063991848>" ;;
            "devjaesung") AUTHOR_MENTION="<@1344112571330072626>" ;;
            "thepott") AUTHOR_MENTION="<@599242098683936770>" ;;
            "nari-0v0") AUTHOR_MENTION="<@323412514224209921>" ;;
            "jongwon-mac") AUTHOR_MENTION="<@580094234711818250>" ;;
            "Hyejeong00") AUTHOR_MENTION="<@848157222625607741>" ;;
            "bottle-gwon") AUTHOR_MENTION="<@361825785654542336>" ;;
            *) AUTHOR_MENTION="@${{ github.event.pull_request.user.login }}" ;;
          esac

          cat > payload.json <<JSON
          {
            "content": "ðŸ”„ **ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!** $AUTHOR_MENTION",
            "embeds": [{
              "title": "â— ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤",
              "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
              "color": 16776960,
              "fields": [
                { "name": "ðŸ‘€ ë¦¬ë·°ì–´", "value": "${{ github.event.review.user.login }}", "inline": true },
                { "name": "ðŸ“ ìš”ì²­ì‚¬í•­", "value": "ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ìžì„¸í•œ ë‚´ìš©ì€ PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.", "inline": false }
              ]
            }]
          }
          JSON
          curl -sS -H "Content-Type: application/json" -X POST --data @payload.json "$DISCORD_WEBHOOK_URL"
